---
alwaysApply: true
---

# VSM Freezer Demo - Agent Rules

**Project**: Virtual Service Mechanic AI for cooling technicians using SMIDO methodology  
**Stack**: Python 3.12, FastAPI, Elysia, Weaviate, DSPy, pandas

---

## Environment Setup (REQUIRED)

```bash
source .venv/bin/activate  # BEFORE any Python commands
```

---

## Quick Start

```bash
source .venv/bin/activate
python3 scripts/seed_default_config.py  # First time only or after relevant updats
elysia start  # Opens on http://localhost:8000
```

---

## Weaviate Collections (Verified Counts)

### Active Collections (Preprocessed with Gemini 2.5 Pro ‚úÖ)
- **VSM_ManualSections**: 167 (4 P's classified, 9 opgave test content)
- **VSM_DiagramUserFacing**: 8 (simple diagrams for technicians (M))
- **VSM_DiagramAgentInternal**: 8 (complex logic for agent (A))
- **VSM_ManualImage**: 233 (photos/figures from manuals, visual troubleshooting)
- **VSM_TelemetryEvent**: 12 ("uit balans" incidents, used by `get_alarms` tool)
- **VSM_VlogCase**: 5 (A1-A5 problem‚Üísolution workflows)
- **VSM_VlogClip**: 15 (individual clips)
- **VSM_WorldStateSnapshot**: 13 (reference patterns)
- **FD_Assets**: 1 (commissioning data, Context C)

### Legacy/Unused Collections
- **FD_Alarms**: 2 (legacy - NOT used by any tools, NOT preprocessed)

**Notes**: 
- "VSM_Diagram" doesn't exist; actual collections are `VSM_DiagramUserFacing` and `VSM_DiagramAgentInternal`
- `get_alarms` tool uses **VSM_TelemetryEvent**, NOT FD_Alarms
- All active collections preprocessed with Gemini 2.5 Pro (Nov 12, 2025)

---

## SMIDO Methodology (M‚ÜíT‚ÜíI‚ÜíD‚ÜíO)

1. **M**elding - Symptom collection, urgency
2. **T**echnisch - Visual inspection, quick checks
3. **I**nstallatie vertrouwd - Schema review, design parameters
4. **D**iagnose - **4 P's** (manual says "3" but lists 4):
   - **P1** Power - Electrical checks
   - **P2** Procesinstellingen - Settings vs design
   - **P3** Procesparameters - Measurements vs design
   - **P4** Productinput - Environmental conditions
5. **O**nderdelen - Component isolation

**Key Concept**: "Uit balans" (out of balance) ‚Äî system operating outside design parameters, not necessarily broken components.

---

## Key Files

### Agent & Tree
- `features/vsm_tree/smido_tree.py` - Agent persona with explicit SMIDO flow, "uit balans" definition
- `features/vsm_tree/bootstrap.py` - Flat root architecture, tool registration, Weaviate-aligned instruction
- `elysia/api/custom_tools.py` - 8 VSM tools (all with collection source transparency)

### Data
- `features/telemetry/timeseries_freezerdata/135_1570_cleaned_with_flags.parquet` - 785K rows (July 2024 - Jan 2026)
- `features/integration_vsm/output/fd_assets_enrichment.json` - Context C
- `features/manuals_vsm/output/manual_sections_classified.jsonl` - 167 sections

### Config
- `.env` - API keys (Gemini, Weaviate)
- `scripts/seed_default_config.py` - Seed frontend config

---

## Critical Patterns

### Model Configuration (.env)
```bash
BASE_MODEL=gemini-2.5-flash
COMPLEX_MODEL=gemini-2.5-pro  # NO "gemini/" prefix!
BASE_PROVIDER=gemini
COMPLEX_PROVIDER=gemini  # Use "gemini" not "google"
```

**Why**: Elysia concatenates `{provider}/{model}` ‚Üí `gemini/gemini-2.5-pro`

### Tool Pattern
```python
from elysia import tool, Result, Status

@tool(status="Processing...", branch_id="smido_melding")
async def my_tool(param: str, tree_data=None, client_manager=None, **kwargs):
    """Docstring with when/what/how."""
    yield Status("Working...")
    result = do_work(param)
    if tree_data:
        tree_data.environment["key"] = result
    yield Result(objects=[result])
```

### Weaviate Query (v4 API)
```python
from elysia.util.client import ClientManager
from weaviate.classes.query import Filter

    async with ClientManager().connect_to_async_client() as client:
        collection = client.collections.get("VSM_ManualSections")
        result = await collection.query.hybrid(
        query="search text",
        filters=Filter.by_property("smido_step").equal("power") &
                Filter.by_property("content_type").not_equal("opgave")
    )
```

---

## Elysia Architecture: Visual Content Display (CRITICAL)

### Why Separate Tools for Images/Diagrams are Required

**Core Principle**: In Elysia, visual content **CANNOT** be displayed by embedding markdown in `Response` objects alone. This is a fundamental architectural constraint.

**The Issue**:
- `Response(text="![Image](url)")` ‚Üí Renders as text in frontend, **NOT** as image
- `Response` objects only yield **text** to the user, no structured payloads
- Markdown in Response text is **NOT parsed** by default Elysia frontend

**The Solution**: Use dedicated tools that yield `Result` objects with proper `payload_type`

### Response vs Result Objects

| Object | Purpose | Frontend Behavior | Environment Impact |
|--------|---------|-------------------|-------------------|
| `Response` | Text-only messages to user | Displayed as markdown/text | **NOT** added to environment |
| `Result` | Structured data + frontend payloads | Rendered via custom components | **Added** to environment for agent context |

### Pattern for Visual Content

```python
@tool
async def search_manual_images(...):
    # ‚ùå WRONG - Will not display images!
    # yield Response("![Image](url)")
    
    # ‚úÖ CORRECT - Frontend receives structured payload
    yield Result(
        objects=[{
            "image_id": "...",
            "image_url": "/static/manual_images/...",
            "image_description": "...",
        }],
        payload_type="image_gallery",  # Frontend knows how to render this
        metadata={...}
    )
```

### Visual Content Tools in VSM

1. **search_manual_images** (233 PNG photos)
   - `payload_type="image_gallery"`
   - Frontend: `ImageGalleryDisplay.tsx` (2-column grid)
   - Weaviate: `VSM_ManualImage` collection

2. **show_diagram** (8 PNG + 8 Mermaid)
   - Dual handling: PNG (UserFacing) OR Mermaid (AgentInternal)
   - PNG: `Response(markdown="![Diagram](url)")`
   - Mermaid: `Response(markdown="```mermaid\n...\n```")`
   - Weaviate: `VSM_DiagramUserFacing` + `VSM_DiagramAgentInternal`

3. **search_manuals_by_smido** (can include diagrams)
   - Returns manual sections + diagrams in same call
   - Diagrams use same dual-handling as `show_diagram`

### Why This Matters

- **Agent cannot "just output" visual content** - needs dedicated tools
- **Frontend needs structured payloads** - custom React components expect specific fields
- **Weaviate preprocessing** maps collection fields ‚Üí frontend fields
- **Tool registration** makes visual content discoverable by agent decision LLM

### Reference
- Docs: `docs/offical/Advanced/custom_objects.md` (Result vs Response)
- Docs: `docs/offical/API/payload_formats.md` (Frontend payloads)
- Docs: `docs/offical/start_here/creating_tools.md` (Tool yielding patterns)

---

## WorldState (W) vs Context (C)

- **W** (Dynamic): Current sensors, flags, trends, health scores (from parquet) given a certain time range
- **C** (Static): Commissioning data, design parameters, target values (from FD_Assets)
- **Balance Check**: Compare W vs C ‚Üí detect "uit balans"

---

## Tools Available in VSM

**VSM uses `branch_initialisation="empty"`** ‚Äî native Elysia tools (query, aggregate, visualise) are **NOT loaded**.

### VSM Custom Tools (10 loaded via bootstrap)
1. `search_manuals_by_smido` - SMIDO-filtered manual + diagram search
2. `search_manual_images` - Visual troubleshooting support (233 manual photos, limit=2)
3. `show_diagram` - Display PNG diagrams (UserFacing) or Mermaid (AgentInternal)
4. `get_current_status` - Quick status check with A3 demo override
5. `get_alarms` - Query VSM_TelemetryEvent by severity
6. `query_telemetry_events` - Historical "uit balans" incidents
7. `query_vlog_cases` - Find A1-A5 problem‚Üísolution cases
8. `compute_worldstate` - Calculate 58 features from parquet (<500ms)
9. `get_asset_health` - W vs C comparison, balance check
10. `analyze_sensor_pattern` - Match against 13 reference snapshots

### Always Available
- `forced_text_response` - Fallback text generation (automatic)

### Native Elysia Tools (NOT in VSM, available in other tree modes)
- `query`, `aggregate`, `visualise`, `cited_summarize`, `summarise_items`
- Loaded in `one_branch` or `multi_branch` init modes
- VSM uses `empty` init ‚Üí only custom tools loaded

---

## Demo Scenario: A3 Frozen Evaporator ‚≠ê

Perfect data alignment across manual, vlog, telemetry:
- **Test**: `python3 scripts/test_plan7_full_tree.py` (~4 min, LLM-driven)
- **Identifies**: Frozen evaporator via M‚ÜíT‚ÜíI‚ÜíD‚ÜíO flow
- **Flags**: `_flag_main_temp_high`, `_flag_suction_extreme`

---

## Bootstrap System

**Auto-loads SMIDO tree + tools:**
```python
Config(
    branch_initialisation="empty",
    feature_bootstrappers=["vsm_smido"]
)
```

**Registry**: `features/vsm_tree/bootstrap.py`  
**Applied by**: `TreeManager.add_tree()` in `elysia/api/services/tree.py`

---

## Testing

```bash
source .venv/bin/activate

# All plans
python3 scripts/run_all_plan_tests.py

# Individual
pytest  # 18/18 WorldState tests
python3 scripts/test_plan2_tools.py  # Query tools
python3 scripts/test_plan7_full_tree.py  # Full A3 scenario
```

---

## Status (Nov 12, 2025)

- ‚úÖ Phase 1: Data Upload COMPLETE (221 objects)
- ‚úÖ Phase 2: Agent & Tools COMPLETE (7 VSM tools, tests passing)
- üîÑ Phase 3: UX & Performance IN PROGRESS (20% complete)

**Critical TODOs**:
1. Redesign branching (flat root + native tools, Weaviate's one_branch pattern)
2. Implement `get_current_status` with `run_if_true` (<200ms)
3. Fix diagram search (VSM_DiagramUserFacing + AgentInternal)

---

## Desired State (Target Architecture)

### Tree Structure
**Pattern**: Flat root + post-tool chains (Weaviate's one_branch philosophy)

```
Root (base)
‚îú‚îÄ‚îÄ get_current_status (<200ms, cached WorldState)
‚îú‚îÄ‚îÄ get_alarms ‚Üí [get_asset_health, query] (M flow)
‚îú‚îÄ‚îÄ compute_worldstate ‚Üí [analyze_pattern, visualise] (P3 flow)
‚îú‚îÄ‚îÄ query_vlog_cases ‚Üí [search_manuals, aggregate] (O flow)
‚îú‚îÄ‚îÄ search_manuals_by_smido
‚îú‚îÄ‚îÄ query, aggregate (native)
‚îî‚îÄ‚îÄ text_response, cited_summarize (always)
```

### Tools Available
- **Root**: 10-12 tools (VSM + native, agent chooses based on intent)
- **Post-tool**: 3-5 tools (context-specific, via `from_tool_ids`)
- **Total**: 7 VSM + 5 native + forced_text_response

### Key Changes from Current
- ‚ùå Remove: Deep SMIDO hierarchy (M‚ÜíT‚ÜíI‚ÜíD‚ÜíO branches)
- ‚úÖ Add: Flat root with all tools
- ‚úÖ Add: Native Elysia tools (query, aggregate, visualise)
- ‚úÖ Add: Fast status tool (get_current_status)
- ‚úÖ Use: Post-tool chains for SMIDO flows
- ‚úÖ Use: Clear tool descriptions (no keyword detection)

### Benefits
- <200ms status checks (run_if_true)
- Native search/stats capabilities
- Simpler code (~200 lines vs ~500)
- Follows Weaviate's proven patterns
- SMIDO methodology preserved (via tool sequences)

---

## Documentation

- **Status**: `docs/project/PROJECT_STATUS.md`
- **History**: `docs/project/PROJECT_HISTORY.md`
- **Knowledge**: `docs/project/PROJECT_KNOWLEDGE.md`
- **TODOs**: `docs/project/PROJECT_TODO.md`
