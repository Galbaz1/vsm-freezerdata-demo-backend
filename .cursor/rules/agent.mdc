---
alwaysApply: true
---

# VSM Freezer Demo - Agent Rules

**Project**: Virtual Service Mechanic AI for cooling technicians using SMIDO methodology  
**Stack**: Python 3.12, FastAPI, Elysia, Weaviate, DSPy, pandas

---

## Environment Setup (REQUIRED)

```bash
source .venv/bin/activate  # BEFORE any Python commands
```

---

## Quick Start

```bash
source .venv/bin/activate
python3 scripts/seed_default_config.py  # First time only or after relevant updats
elysia start  # Opens on http://localhost:8000
```

---

## Weaviate Collections (Verified Counts)

### Active Collections (Preprocessed with Gemini 2.5 Pro âœ…)
- **VSM_ManualSections**: 167 (4 P's classified, 9 opgave test content)
- **VSM_DiagramUserFacing**: 8 (simple diagrams for technicians (M))
- **VSM_DiagramAgentInternal**: 8 (complex logic for agent (A))
- **VSM_ManualImage**: 233 (photos/figures from manuals, visual troubleshooting)
- **VSM_TelemetryEvent**: 12 ("uit balans" incidents, used by `get_alarms` tool)
- **VSM_VlogCase**: 5 (A1-A5 problemâ†’solution workflows)
- **VSM_VlogClip**: 15 (individual clips)
- **VSM_WorldStateSnapshot**: 13 (reference patterns)
- **FD_Assets**: 1 (commissioning data, Context C)

### Legacy/Unused Collections
- **FD_Alarms**: 2 (legacy - NOT used by any tools, NOT preprocessed)

**Notes**: 
- "VSM_Diagram" doesn't exist; actual collections are `VSM_DiagramUserFacing` and `VSM_DiagramAgentInternal`
- `get_alarms` tool uses **VSM_TelemetryEvent**, NOT FD_Alarms
- All active collections preprocessed with Gemini 2.5 Pro (Nov 12, 2025)

---

## SMIDO Methodology (Mâ†’Tâ†’Iâ†’Dâ†’O)

1. **M**elding - Symptom collection, urgency
2. **T**echnisch - Visual inspection, quick checks
3. **I**nstallatie vertrouwd - Schema review, design parameters
4. **D**iagnose - **4 P's** (manual says "3" but lists 4):
   - **P1** Power - Electrical checks
   - **P2** Procesinstellingen - Settings vs design
   - **P3** Procesparameters - Measurements vs design
   - **P4** Productinput - Environmental conditions
5. **O**nderdelen - Component isolation

**Key Concept**: "Uit balans" (out of balance) â€” system operating outside design parameters, not necessarily broken components.

---

## Key Files

### Agent & Tree
- `features/vsm_tree/smido_tree.py` - Agent persona with explicit SMIDO flow, "uit balans" definition
- `features/vsm_tree/bootstrap.py` - Flat root architecture, tool registration, Weaviate-aligned instruction
- `elysia/api/custom_tools.py` - 8 VSM tools (all with collection source transparency)

### Data
- `features/telemetry/timeseries_freezerdata/135_1570_cleaned_with_flags.parquet` - 785K rows (July 2024 - Jan 2026)
- `features/integration_vsm/output/fd_assets_enrichment.json` - Context C
- `features/manuals_vsm/output/manual_sections_classified.jsonl` - 167 sections

### Config
- `.env` - API keys (Gemini, Weaviate)
- `scripts/seed_default_config.py` - Seed frontend config

---

## Critical Patterns

### Model Configuration (.env)
```bash
BASE_MODEL=gemini-2.5-flash
COMPLEX_MODEL=gemini-2.5-pro  # NO "gemini/" prefix!
BASE_PROVIDER=gemini
COMPLEX_PROVIDER=gemini  # Use "gemini" not "google"
```

**Why**: Elysia concatenates `{provider}/{model}` â†’ `gemini/gemini-2.5-pro`

### Tool Pattern
```python
from elysia import tool, Result, Status

@tool(status="Processing...", branch_id="smido_melding")
async def my_tool(param: str, tree_data=None, client_manager=None, **kwargs):
    """Docstring with when/what/how."""
    yield Status("Working...")
    result = do_work(param)
    if tree_data:
        tree_data.environment["key"] = result
    yield Result(objects=[result])
```

### Weaviate Query (v4 API)
```python
from elysia.util.client import ClientManager
from weaviate.classes.query import Filter

async with ClientManager().connect_to_async_client() as client:
    collection = client.collections.get("VSM_ManualSections")
    result = await collection.query.hybrid(
        query="search text",
        filters=Filter.by_property("smido_step").equal("power") &
                Filter.by_property("content_type").not_equal("opgave")
    )
```

---

## WorldState (W) vs Context (C)

- **W** (Dynamic): Current sensors, flags, trends, health scores (from parquet) given a certain time range
- **C** (Static): Commissioning data, design parameters, target values (from FD_Assets)
- **Balance Check**: Compare W vs C â†’ detect "uit balans"

---

## Tools Available in VSM

**VSM uses `branch_initialisation="empty"`** â€” native Elysia tools (query, aggregate, visualise) are **NOT loaded**.

### VSM Custom Tools (9 loaded via bootstrap)
1. `search_manuals_by_smido` - SMIDO-filtered manual + diagram search
2. `search_manual_images` - Visual troubleshooting support (233 manual photos)
3. `get_current_status` - Quick status check with A3 demo override
4. `get_alarms` - Query VSM_TelemetryEvent by severity
5. `query_telemetry_events` - Historical "uit balans" incidents
6. `query_vlog_cases` - Find A1-A5 problemâ†’solution cases
7. `compute_worldstate` - Calculate 58 features from parquet (<500ms)
8. `get_asset_health` - W vs C comparison, balance check
9. `analyze_sensor_pattern` - Match against 13 reference snapshots

### Always Available
- `forced_text_response` - Fallback text generation (automatic)

### Native Elysia Tools (NOT in VSM, available in other tree modes)
- `query`, `aggregate`, `visualise`, `cited_summarize`, `summarise_items`
- Loaded in `one_branch` or `multi_branch` init modes
- VSM uses `empty` init â†’ only custom tools loaded

---

## Demo Scenario: A3 Frozen Evaporator â­

Perfect data alignment across manual, vlog, telemetry:
- **Test**: `python3 scripts/test_plan7_full_tree.py` (~4 min, LLM-driven)
- **Identifies**: Frozen evaporator via Mâ†’Tâ†’Iâ†’Dâ†’O flow
- **Flags**: `_flag_main_temp_high`, `_flag_suction_extreme`

---

## Bootstrap System

**Auto-loads SMIDO tree + tools:**
```python
Config(
    branch_initialisation="empty",
    feature_bootstrappers=["vsm_smido"]
)
```

**Registry**: `features/vsm_tree/bootstrap.py`  
**Applied by**: `TreeManager.add_tree()` in `elysia/api/services/tree.py`

---

## Testing

```bash
source .venv/bin/activate

# All plans
python3 scripts/run_all_plan_tests.py

# Individual
pytest  # 18/18 WorldState tests
python3 scripts/test_plan2_tools.py  # Query tools
python3 scripts/test_plan7_full_tree.py  # Full A3 scenario
```

---

## Status (Nov 12, 2025)

- âœ… Phase 1: Data Upload COMPLETE (221 objects)
- âœ… Phase 2: Agent & Tools COMPLETE (7 VSM tools, tests passing)
- ðŸ”„ Phase 3: UX & Performance IN PROGRESS (20% complete)

**Critical TODOs**:
1. Redesign branching (flat root + native tools, Weaviate's one_branch pattern)
2. Implement `get_current_status` with `run_if_true` (<200ms)
3. Fix diagram search (VSM_DiagramUserFacing + AgentInternal)

---

## Desired State (Target Architecture)

### Tree Structure
**Pattern**: Flat root + post-tool chains (Weaviate's one_branch philosophy)

```
Root (base)
â”œâ”€â”€ get_current_status (<200ms, cached WorldState)
â”œâ”€â”€ get_alarms â†’ [get_asset_health, query] (M flow)
â”œâ”€â”€ compute_worldstate â†’ [analyze_pattern, visualise] (P3 flow)
â”œâ”€â”€ query_vlog_cases â†’ [search_manuals, aggregate] (O flow)
â”œâ”€â”€ search_manuals_by_smido
â”œâ”€â”€ query, aggregate (native)
â””â”€â”€ text_response, cited_summarize (always)
```

### Tools Available
- **Root**: 10-12 tools (VSM + native, agent chooses based on intent)
- **Post-tool**: 3-5 tools (context-specific, via `from_tool_ids`)
- **Total**: 7 VSM + 5 native + forced_text_response

### Key Changes from Current
- âŒ Remove: Deep SMIDO hierarchy (Mâ†’Tâ†’Iâ†’Dâ†’O branches)
- âœ… Add: Flat root with all tools
- âœ… Add: Native Elysia tools (query, aggregate, visualise)
- âœ… Add: Fast status tool (get_current_status)
- âœ… Use: Post-tool chains for SMIDO flows
- âœ… Use: Clear tool descriptions (no keyword detection)

### Benefits
- <200ms status checks (run_if_true)
- Native search/stats capabilities
- Simpler code (~200 lines vs ~500)
- Follows Weaviate's proven patterns
- SMIDO methodology preserved (via tool sequences)

---

## Documentation

- **Status**: `docs/project/PROJECT_STATUS.md`
- **History**: `docs/project/PROJECT_HISTORY.md`
- **Knowledge**: `docs/project/PROJECT_KNOWLEDGE.md`
- **TODOs**: `docs/project/PROJECT_TODO.md`
