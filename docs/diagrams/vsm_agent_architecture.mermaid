%% Title: VSM Agent Architecture - Intelligent SMIDO Troubleshooting System
%% Description: Complete architecture showing how VSM agent builds on Elysia framework with SMIDO methodology, WorldState computation, and multi-source data integration
%% Created: 2025-01-11
%% Status: Proposed Architecture

graph TB
    subgraph UILayer["User Interface Layer"]
        Technician["ðŸ‘· Junior Technician"]
        UI["VSM Dashboard UI"]
        Query["User Query<br/>Koelcel bereikt temperatuur niet"]
    end

    subgraph VSMOrchestration["VSM Agent Orchestration Layer"]
        VSMTree["VSM Tree Instance<br/>extends Elysia Tree"]
        SMIDOOrchestrator["SMIDO Orchestrator<br/>M to T to I to D to O Workflow"]
        ContextManager["Context Manager<br/>W: WorldState dynamic<br/>C: Context static design"]
    end

    subgraph SMIDOTree["SMIDO Decision Tree - Elysia Decision Nodes"]
        M_Node["M - MELDING<br/>Symptom Collection<br/>DecisionNode"]
        T_Node["T - TECHNISCH<br/>Quick Visual Check<br/>DecisionNode"]
        I_Node["I - INSTALLATIE<br/>Familiarity Check<br/>DecisionNode"]
        D_Node["D - DIAGNOSE<br/>4 Ps Branch<br/>DecisionNode"]
        P1_Node["P1: POWER<br/>Electrical supply<br/>DecisionNode"]
        P2_Node["P2: PROCESINSTELLINGEN<br/>Settings vs design<br/>DecisionNode"]
        P3_Node["P3: PROCESPARAMETERS<br/>Measurements vs design<br/>DecisionNode"]
        P4_Node["P4: PRODUCTINPUT<br/>External conditions vs design<br/>DecisionNode"]
        O_Node["O - ONDERDELEN<br/>Component Isolation<br/>DecisionNode"]
    end

    subgraph VSMTools["VSM Domain Tools - Elysia Tools"]
        WorldStateTool["ComputeWorldState Tool<br/>60+ features from parquet"]
        TelemetryEventTool["QueryTelemetryEvents Tool<br/>Historical incidents"]
        ManualSearchTool["SearchManualsBySMIDO Tool<br/>SMIDO-filtered search"]
        VlogCaseTool["QueryVlogCases Tool<br/>Similar case matching"]
        AlarmTool["GetAlarms Tool<br/>Active alarm retrieval"]
        AssetHealthTool["GetAssetHealth Tool<br/>Health summary"]
        SensorPatternTool["AnalyzeSensorPattern Tool<br/>Pattern detection"]
    end

    subgraph ElysiaCore["Elysia Core - Reused"]
        ElysiaTree["Elysia Tree Engine<br/>Decision orchestration"]
        ElysiaQuery["Query Tool<br/>Weaviate hybrid search"]
        ElysiaAggregate["Aggregate Tool<br/>Statistics & metrics"]
        ElysiaText["Text Response Tool<br/>Final answers"]
        TreeData["TreeData/Environment<br/>Global state"]
        DSPyModule["DSPy ChainOfThought<br/>LLM integration"]
    end

    subgraph DataComputation["Data Computation Layer"]
        WorldStateEngine["WorldState Engine<br/>Feature computation"]
        ParquetReader["Parquet Reader<br/>Time-window queries"]
        EventDetector["Event Detector<br/>Incident detection"]
        PatternAnalyzer["Pattern Analyzer<br/>Anomaly detection"]
    end

    subgraph WeaviateColls["Weaviate Collections - Semantic Search"]
        VSM_ManualSections["VSM_ManualSections<br/>~240 logical sections<br/>SMIDO-tagged"]
        VSM_Diagram["VSM_Diagram<br/>9 Mermaid diagrams<br/>Visual logic"]
        VSM_TelemetryEvent["VSM_TelemetryEvent<br/>~1000 incidents<br/>WorldState metadata"]
        VSM_VlogCase["VSM_VlogCase<br/>5 aggregated cases<br/>Problem to Solution"]
        VSM_VlogClip["VSM_VlogClip<br/>15 individual clips<br/>Timestamped"]
        VSM_WorldStateSnapshot["VSM_WorldStateSnapshot<br/>5-10 reference patterns<br/>SYNTHETIC"]
        FD_Assets_Enriched["FD_Assets Enriched<br/>Installation context<br/>SYNTHETIC"]
        ELYSIA_METADATA["ELYSIA_METADATA__<br/>Collection schemas<br/>Display types"]
    end

    subgraph LocalStorage["Local Data Storage - Raw Data"]
        TelemetryParquet["Telemetry Parquet<br/>785K datapoints<br/>1-min intervals"]
        ManualJSONL["Manual JSONL<br/>922 chunks<br/>Source data"]
        VlogMOV["Vlog .mov Files<br/>15 videos<br/>21.7 MB"]
    end

    subgraph LLMLayer["LLM Layer - DSPy"]
        BaseLM["Base LM<br/>gemini-1.5-flash<br/>Fast decisions"]
        ComplexLM["Complex LM<br/>gemini-1.5-pro<br/>Deep analysis"]
        FeedbackSystem["Feedback System<br/>Few-shot learning<br/>User-specific"]
    end

    %% User Flow
    Technician --> Query
    Query --> UI
    UI --> VSMTree

    %% VSM Orchestration
    VSMTree --> SMIDOOrchestrator
    VSMTree --> ContextManager
    VSMTree --> ElysiaTree
    SMIDOOrchestrator --> M_Node

    %% SMIDO Workflow
    M_Node -->|"Symptom collected"| T_Node
    T_Node -->|"No visual defect"| I_Node
    I_Node -->|"Familiar"| D_Node
    I_Node -->|"Not familiar"| ManualSearchTool
    D_Node --> P1_Node
    P1_Node -->|"Power OK"| P2_Node
    P2_Node -->|"Settings OK"| P3_Node
    P3_Node -->|"Need measurements"| WorldStateTool
    P3_Node -->|"Parameters OK"| P4_Node
    P4_Node -->|"All P's OK"| O_Node
    O_Node -->|"Solution found"| ElysiaText

    %% Tool Execution Flow
    M_Node --> AlarmTool
    T_Node --> AssetHealthTool
    P1_Node --> AlarmTool
    P2_Node --> ManualSearchTool
    P3_Node --> WorldStateTool
    P3_Node --> SensorPatternTool
    P4_Node --> TelemetryEventTool
    O_Node --> VlogCaseTool
    O_Node --> ManualSearchTool

    %% WorldState Computation
    WorldStateTool --> WorldStateEngine
    WorldStateEngine --> ParquetReader
    ParquetReader --> TelemetryParquet
    WorldStateEngine --> EventDetector
    WorldStateEngine --> PatternAnalyzer
    WorldStateEngine --> TreeData

    %% Weaviate Queries
    TelemetryEventTool --> ElysiaQuery
    ManualSearchTool --> ElysiaQuery
    VlogCaseTool --> ElysiaQuery
    AlarmTool --> ElysiaQuery
    AssetHealthTool --> ElysiaQuery
    SensorPatternTool --> ElysiaQuery
    ElysiaQuery --> VSM_ManualSections
    ElysiaQuery --> VSM_Diagram
    ElysiaQuery --> VSM_TelemetryEvent
    ElysiaQuery --> VSM_VlogCase
    ElysiaQuery --> VSM_VlogClip
    ElysiaQuery --> VSM_WorldStateSnapshot
    ElysiaQuery --> FD_Assets_Enriched
    ElysiaQuery --> ELYSIA_METADATA

    %% Elysia Core Integration
    VSMTree --> TreeData
    ElysiaTree --> DSPyModule
    DSPyModule --> BaseLM
    DSPyModule --> ComplexLM
    DSPyModule --> FeedbackSystem
    TreeData --> DSPyModule

    %% Data Import Flow (Background)
    TelemetryParquet -.->|"Event detection"| EventDetector
    EventDetector -.->|"Import"| VSM_TelemetryEvent
    ManualJSONL -.->|"Section grouping"| VSM_ManualSections
    VlogMOV -.->|"Metadata extraction"| VSM_VlogCase
    VlogMOV -.->|"Clip processing"| VSM_VlogClip

    %% Cross-linking
    VSM_TelemetryEvent -.->|"related_manual_sections"| VSM_ManualSections
    VSM_TelemetryEvent -.->|"related_vlog_cases"| VSM_VlogCase
    VSM_VlogCase -.->|"related_manual_sections"| VSM_ManualSections

    %% Styling
    classDef userLayer fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef vsmLayer fill:#f3e5f5,stroke:#4a148c,stroke-width:3px
    classDef smidoNode fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef vsmTool fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef elysiaCore fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef computation fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef weaviate fill:#e8eaf6,stroke:#283593,stroke-width:2px
    classDef localData fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    classDef llm fill:#e0f2f1,stroke:#004d40,stroke-width:2px

    class Technician,UI,Query userLayer
    class VSMTree,SMIDOOrchestrator,ContextManager vsmLayer
    class M_Node,T_Node,I_Node,D_Node,P1_Node,P2_Node,P3_Node,P4_Node,O_Node smidoNode
    class WorldStateTool,TelemetryEventTool,ManualSearchTool,VlogCaseTool,AlarmTool,AssetHealthTool,SensorPatternTool vsmTool
    class ElysiaTree,ElysiaQuery,ElysiaAggregate,ElysiaText,TreeData,DSPyModule elysiaCore
    class WorldStateEngine,ParquetReader,EventDetector,PatternAnalyzer computation
    class VSM_ManualSections,VSM_Diagram,VSM_TelemetryEvent,VSM_VlogCase,VSM_VlogClip,VSM_WorldStateSnapshot,FD_Assets_Enriched,ELYSIA_METADATA weaviate
    class TelemetryParquet,ManualJSONL,VlogMOV localData
    class BaseLM,ComplexLM,FeedbackSystem llm
